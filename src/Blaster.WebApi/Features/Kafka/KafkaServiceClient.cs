using System;
using System.Collections.Generic;
using System.Net.Http;
using System.Text;
using System.Threading.Tasks;
using Blaster.WebApi.Features.Capabilities.Models;
using Blaster.WebApi.Features.Shared;

namespace Blaster.WebApi.Features.Capabilities
{
	public class KafkaServiceClient : IKafkaServiceClient
	{
		private readonly HttpClient _client;
		private readonly JsonSerializer _serializer;

		public KafkaServiceClient(HttpClient client, JsonSerializer serializer)
		{
			_client = client;
			_serializer = serializer;
		}

		public async Task<TopicsResponse> GetByCapabilityId(string capabilityId)
		{
			var response = await _client.GetAsync($"/api/v1/capabilities/{capabilityId}/topics");
			HttpResponseHelper.EnsureSuccessStatusCode(response);
			var content = await response.Content.ReadAsStringAsync();

			return _serializer.Deserialize<TopicsResponse>(content);
		}

		public async Task<TopicsResponse> GetAll()
		{
			var response = await _client.GetAsync($"/api/v1/topics");
			HttpResponseHelper.EnsureSuccessStatusCode(response);
			var content = await response.Content.ReadAsStringAsync();

			return _serializer.Deserialize<TopicsResponse>(content);
		}

		public async Task<IEnumerable<KafkaCluster>> GetAllClusters()
		{
			var response = await _client.GetAsync($"/api/v1/kafka/cluster");
			HttpResponseHelper.EnsureSuccessStatusCode(response);
			var content = await response.Content.ReadAsStringAsync();

			return _serializer.Deserialize<IEnumerable<KafkaCluster>>(content);
		}
		
		public async Task<Topic> CreateTopic(string capabilityId, CreateTopicRequest createTopicRequest)
		{
			var reqContent = new StringContent(
				content: _serializer.Serialize(createTopicRequest),
				encoding: Encoding.UTF8,
				mediaType: "application/json"
			);

			var response = await _client.PostAsync($"/api/v1/capabilities/{capabilityId}/topics", reqContent);
			await HttpResponseHelper.MapStatusCodeToException(response);
			
			var content = await response.Content.ReadAsStringAsync();

			return _serializer.Deserialize<Topic>(content);
		}

		public async Task ForwardHeader(string headerName, string headerValue)
		{
			_client.DefaultRequestHeaders.Add(headerName, headerValue);
		}
	}
}
